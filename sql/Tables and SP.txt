USE [qm]
GO
/****** Object:  Table [dbo].[ReportsGenerated]    Script Date: 08/05/2018 18:33:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ReportsGenerated](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ReportGeneratedFileName] [varchar](max) NULL,
	[CreatedOn] [datetime] NULL,
	[CreatedBy] [varchar](max) NULL,
	[MethodofCreation] [varchar](max) NULL,
	[ReportGeneratedFullPath] [varchar](max) NULL,
	[ReportLocation] [varchar](max) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  StoredProcedure [dbo].[GetAllWorkGroups]    Script Date: 08/05/2018 18:33:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetAllWorkGroups] 
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	Select workgroupid, workgroupname from workgroup where status = 1
END

GO
/****** Object:  StoredProcedure [dbo].[GetReport]    Script Date: 08/05/2018 18:33:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Mujeeb K S
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
USE [qm]
GO
/****** Object:  StoredProcedure [dbo].[GetReport]    Script Date: 08/05/2018 19:03:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Mujeeb K S
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[GetReport] 
	@startdate datetime,
	@endDate datetime,
	@workgroupid varchar(max)
AS
BEGIN
    set nocount off

	select m.starttime, m.endtime, m.mediaid, m.dnis, m.ani, r.updateuserid,
	r.percentscore, r.overallscore,
	r.reviewdate, i.username, i.userroleid, i.usertypeid,
	w.workgroupname, s.[description], s.[name], s.sequencenumber, 
	q.questiondescription, q.questionnumber, q.questiontext, q.responserequired,
	q.questionadditionalpoint, q.autofailpoint, q.questionadditionalconditionpoint,
	sr.weightedscore, s.[weight] as sectionWeight,
	qr.responsetext, q.[weight] as questionWeight,
	qt.questiontypedesc, qt.scored as questionScored
	from media m inner join review r on m.mediaid = r.mediaid
	inner join iqmuser i on i.userid = r.owneruserid
	inner join workgroup_iqmuser wi on wi.userid = r.owneruserid
	inner join workgroup w on w.workgroupid = wi.workgroupid
	inner join sectionresult sr on sr.reviewid = r.reviewid
	inner join section s on s.sectionid = sr.sectionid
	inner join question q on q.sectionid = s.sectionid
	inner join questionresult qr on q.questionid = qr.questionid
	inner join questiontype qt on qt.questiontypeid = q.questiontypeid
	where (m.starttime BETWEEN @startdate AND @endDate) OR 
	(m.endtime BETWEEN @startdate AND @endDate) OR 
	(m.starttime <= @startdate AND m.endtime >= @endDate) and
	w.workgroupid in ( @workgroupid )


END

GO
/****** Object:  StoredProcedure [dbo].[GetReportcsvList]    Script Date: 08/05/2018 18:33:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetReportcsvList] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	--SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT ID, ReportGeneratedFileName, CreatedOn, CreatedBy, MethodofCreation, ReportGeneratedFullPath, ReportLocation
	FROM     ReportsGenerated order by ID desc
END



GO
/****** Object:  StoredProcedure [dbo].[GetReportDailyJob]    Script Date: 08/05/2018 18:33:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Mujeeb K S
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetReportDailyJob] 
	@startdate datetime,
	@endDate datetime,
	@workgroupid uniqueidentifier = null
AS
BEGIN
if (@workgroupid is null)
begin
	select m.starttime, m.endtime, m.mediaid, m.dnis, m.ani, r.updateuserid,
	r.percentscore, r.overallscore,
	r.reviewdate, i.username, i.userroleid, i.usertypeid,
	w.workgroupname, s.description, s.name, s.sequencenumber, 
	q.questiondescription, q.questionnumber, q.questiontext, q.responserequired,
	q.questionadditionalpoint, q.autofailpoint, q.questionadditionalconditionpoint,
	CONCAT(sr.weightedscore, ' : ', s.weight) as sectionResult, CONCAT(qr.responsetext, ' : ', q.weight) as questionResult,
	CONCAT(qt.questiontypedesc, ' : ', qt.scored) as questionType
	from media m inner join review r on m.mediaid = r.mediaid
	inner join iqmuser i on i.userid = r.owneruserid
	inner join workgroup_iqmuser wi on wi.userid = r.owneruserid
	inner join workgroup w on w.workgroupid = wi.workgroupid
	inner join sectionresult sr on sr.reviewid = r.reviewid
	inner join section s on s.sectionid = sr.sectionid
	inner join question q on q.sectionid = s.sectionid
	inner join questionresult qr on q.questionid = qr.questionid
	inner join questiontype qt on qt.questiontypeid = q.questiontypeid
	where m.starttime >= @startdate and m.endtime <= @endDate
end
else 
begin
select m.starttime, m.endtime, m.mediaid, m.dnis, m.ani, r.updateuserid,
	r.percentscore, r.overallscore,
	r.reviewdate, i.username, i.userroleid, i.usertypeid,
	w.workgroupname, s.description, s.name, s.sequencenumber, s.weight as sweight,
	q.questiondescription, q.questionnumber, q.questiontext, q.weight as qweight, q.responserequired,
	q.questionadditionalpoint, q.autofailpoint, q.questionadditionalconditionpoint,
	CONCAT(sr.weightedscore, ' : ', s.weight) as sectionResult, CONCAT(qr.responsetext, ' : ', q.weight) as questionResult,
	CONCAT(qt.questiontypedesc, ' : ', qt.scored) as questionType
	from media m inner join review r on m.mediaid = r.mediaid
	inner join iqmuser i on i.userid = r.owneruserid
	inner join workgroup_iqmuser wi on wi.userid = r.owneruserid
	inner join workgroup w on w.workgroupid = wi.workgroupid
	inner join sectionresult sr on sr.reviewid = r.reviewid
	inner join section s on s.sectionid = sr.sectionid
	inner join question q on q.sectionid = s.sectionid
	inner join questionresult qr on q.questionid = qr.questionid
	inner join questiontype qt on qt.questiontypeid = q.questiontypeid
	where w.workgroupid = @workgroupid and m.starttime >= @startdate and m.endtime <= @endDate
end
END

GO
/****** Object:  StoredProcedure [dbo].[GetReportList]    Script Date: 08/05/2018 18:33:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetReportList] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	Select ID, ReportGenerated, CreatedOn, CreatedBy from ReportsGenerated order by ID desc
END
GO
/****** Object:  StoredProcedure [dbo].[InsertReport]    Script Date: 08/05/2018 18:33:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[InsertReport]  

    @ReportGeneratedFileName varchar(MAX),
	@CreatedOn datetime,
	@CreatedBy varchar(MAX),
	@MethodofCreation varchar(MAX),
	@ReportGeneratedFullPath varchar(MAX),
	@ReportLocation varchar(MAX)

AS 
BEGIN 
    --SET NOCOUNT ON; 

      INSERT INTO [dbo].[ReportsGenerated] 
	  (
	   ReportGeneratedFileName,
	   CreatedOn, 
	   CreatedBy,
	   MethodofCreation,
	   ReportGeneratedFullPath,
	   ReportLocation
	  
	  ) 

VALUES (

    @ReportGeneratedFileName,
	@CreatedOn,
	@CreatedBy,
	@MethodofCreation,
	@ReportGeneratedFullPath,
	@ReportLocation
); 


END 
GO
